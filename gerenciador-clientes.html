<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
    <title>📊 VRS Gerenciador de Clientes - Mobile</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Meta tags para PWA -->
    <meta name="theme-color" content="#667eea">
    <meta name="background-color" content="#667eea">
    <meta name="display" content="standalone">
    <meta name="orientation" content="portrait-primary">
    
    <!-- Meta tags para mobile -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="VRS Clientes">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 1rem;
        }

        .manager-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
        }

        .manager-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .manager-content {
            padding: 2rem;
        }

        .stats-card {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .stats-card h3 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .cliente-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 5px solid #007bff;
            transition: transform 0.2s;
        }

        .cliente-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .backup-status {
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 10px;
            padding: 0.5rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .btn-action {
            border-radius: 8px;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            font-weight: 600;
        }

        .search-box {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .search-box:focus {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.25);
        }

        .alert-backup {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 1rem;
        }

        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }
            
            .manager-header, .manager-content {
                padding: 1.5rem 1rem;
            }
            
            .stats-card h3 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="manager-container">
        <!-- Cabeçalho -->
        <div class="manager-header">
            <h1><i class="fas fa-users-cog me-2"></i>Gerenciador de Clientes</h1>
            <p class="mb-0">Sistema de backup e recuperação - Oficina VRS</p>
        </div>

        <!-- Conteúdo -->
        <div class="manager-content">
            
            <!-- Status de Backup -->
            <div class="alert alert-backup">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>Sistema de Backup Ativo</strong>
                        <br>
                        <small>Último backup: <span id="ultimoBackupTime">Verificando...</span></small>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-light btn-sm" onclick="criarBackupManual()">
                            <i class="fas fa-save me-1"></i>Backup Manual
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3 id="totalClientes">0</h3>
                        <p class="mb-0">Total de Clientes</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3 id="totalBackups">0</h3>
                        <p class="mb-0">Backups Salvos</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3 id="cadastrosHoje">0</h3>
                        <p class="mb-0">Cadastros Hoje</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <h3 id="tamanhoTotal">0KB</h3>
                        <p class="mb-0">Dados Salvos</p>
                    </div>
                </div>
            </div>

            <!-- Ações Rápidas -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5><i class="fas fa-bolt me-2"></i>Ações Rápidas</h5>
                    <button class="btn btn-success btn-action" onclick="exportarTodos()">
                        <i class="fas fa-download me-1"></i>Exportar Todos
                    </button>
                    <button class="btn btn-warning btn-action" onclick="importarDados()">
                        <i class="fas fa-upload me-1"></i>Importar Dados
                    </button>
                    <button class="btn btn-info btn-action" onclick="abrirSistemaBackup()">
                        <i class="fas fa-cog me-1"></i>Sistema Backup
                    </button>
                    <button class="btn btn-danger btn-action" onclick="limparTodos()">
                        <i class="fas fa-trash me-1"></i>Limpar Tudo
                    </button>
                    <button class="btn btn-primary btn-action" onclick="recuperarUltimo()">
                        <i class="fas fa-undo me-1"></i>Recuperar Último
                    </button>
                </div>
            </div>

            <!-- Busca -->
            <div class="row">
                <div class="col-12">
                    <input type="text" 
                           class="form-control search-box" 
                           id="searchInput" 
                           placeholder="🔍 Buscar cliente por nome, telefone, e-mail ou veículo..."
                           onkeyup="filtrarClientes()">
                </div>
            </div>

            <!-- Lista de Clientes -->
            <div class="row">
                <div class="col-12">
                    <h5><i class="fas fa-list me-2"></i>Lista de Clientes</h5>
                    <div id="listaClientes">
                        <!-- Clientes serão carregados aqui -->
                    </div>
                </div>
            </div>

            <!-- Input para importação (invisível) -->
            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="processarArquivo(this)">
        </div>
    </div>

    <script>
        let clientesData = [];

        // Inicializar sistema
        document.addEventListener('DOMContentLoaded', function() {
            carregarDados();
            atualizarEstatisticas();
            exibirClientes();
            
            // Atualizar a cada 30 segundos
            setInterval(() => {
                carregarDados();
                atualizarEstatisticas();
            }, 30000);
        });

        // Carregar dados do localStorage
        function carregarDados() {
            try {
                clientesData = JSON.parse(localStorage.getItem('clientes') || '[]');
                console.log('📊 Dados carregados:', clientesData.length, 'clientes');
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
                clientesData = [];
            }
        }

        // Atualizar estatísticas
        function atualizarEstatisticas() {
            // Total de clientes
            document.getElementById('totalClientes').textContent = clientesData.length;
            
            // Total de backups
            const backups = JSON.parse(localStorage.getItem('backups') || '[]');
            document.getElementById('totalBackups').textContent = backups.length;
            
            // Cadastros hoje
            const hoje = new Date().toDateString();
            const cadastrosHoje = clientesData.filter(cliente => 
                new Date(cliente.dataCadastro).toDateString() === hoje
            ).length;
            document.getElementById('cadastrosHoje').textContent = cadastrosHoje;
            
            // Tamanho total dos dados
            let tamanhoTotal = 0;
            ['clientes', 'backups', 'historico_cadastros'].forEach(chave => {
                const dados = localStorage.getItem(chave);
                if (dados) tamanhoTotal += dados.length;
            });
            document.getElementById('tamanhoTotal').textContent = Math.round(tamanhoTotal / 1024) + 'KB';
            
            // Último backup
            const ultimoBackup = localStorage.getItem('ultimo_backup');
            if (ultimoBackup) {
                const data = new Date(ultimoBackup);
                document.getElementById('ultimoBackupTime').textContent = data.toLocaleString('pt-BR');
            }
        }

        // Exibir lista de clientes
        function exibirClientes() {
            const container = document.getElementById('listaClientes');
            
            if (clientesData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-users text-muted" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-muted">Nenhum cliente cadastrado</h5>
                        <p class="text-muted">Os clientes cadastrados aparecerão aqui.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            clientesData.forEach((cliente, index) => {
                const dataCadastro = new Date(cliente.dataCadastro);
                const tempoDecorrido = calcularTempoDecorrido(dataCadastro);
                
                html += `
                    <div class="cliente-card" data-index="${index}">
                        <div class="row">
                            <div class="col-md-8">
                                <h6><i class="fas fa-user me-2"></i>${cliente.nomeCompleto}</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <i class="fas fa-phone me-1"></i>${cliente.telefone}<br>
                                            <i class="fas fa-envelope me-1"></i>${cliente.email}
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <i class="fas fa-car me-1"></i>${cliente.marca} ${cliente.modelo} ${cliente.ano}<br>
                                            <i class="fas fa-map-marker-alt me-1"></i>${cliente.cidade}/${cliente.estado}
                                        </small>
                                    </div>
                                </div>
                                <div class="backup-status">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Backup seguro • Cadastrado ${tempoDecorrido}
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="d-flex flex-column gap-2">
                                    <button class="btn btn-sm btn-primary" onclick="editarCliente(${index})">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="contatarCliente(${index})">
                                        <i class="fas fa-whatsapp"></i> WhatsApp
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="criarBackupCliente(${index})">
                                        <i class="fas fa-save"></i> Backup
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="excluirCliente(${index})">
                                        <i class="fas fa-trash"></i> Excluir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Calcular tempo decorrido
        function calcularTempoDecorrido(data) {
            const agora = new Date();
            const diferenca = agora - data;
            const horas = Math.floor(diferenca / (1000 * 60 * 60));
            const dias = Math.floor(horas / 24);
            
            if (dias > 0) return `há ${dias} dia${dias > 1 ? 's' : ''}`;
            if (horas > 0) return `há ${horas} hora${horas > 1 ? 's' : ''}`;
            return 'agora';
        }

        // Filtrar clientes
        function filtrarClientes() {
            const busca = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.cliente-card');
            
            cards.forEach(card => {
                const texto = card.textContent.toLowerCase();
                card.style.display = texto.includes(busca) ? 'block' : 'none';
            });
        }

        // Criar backup manual
        function criarBackupManual() {
            try {
                const backup = {
                    id: 'manual_' + Date.now(),
                    timestamp: new Date().toISOString(),
                    tipo: 'Manual',
                    dados: clientesData,
                    versao: '1.0.0'
                };
                
                let backups = JSON.parse(localStorage.getItem('backups') || '[]');
                backups.unshift(backup);
                if (backups.length > 20) backups = backups.slice(0, 20);
                localStorage.setItem('backups', JSON.stringify(backups));
                localStorage.setItem('ultimo_backup', backup.timestamp);
                
                alert('✅ Backup manual criado com sucesso!');
                atualizarEstatisticas();
            } catch (error) {
                alert('❌ Erro ao criar backup: ' + error.message);
            }
        }

        // Exportar todos os dados
        function exportarTodos() {
            try {
                const dadosCompletos = {
                    clientes: clientesData,
                    backups: JSON.parse(localStorage.getItem('backups') || '[]'),
                    historico: JSON.parse(localStorage.getItem('historico_cadastros') || '[]'),
                    timestamp: new Date().toISOString(),
                    versao: '1.0.0'
                };
                
                const dataStr = JSON.stringify(dadosCompletos, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `backup_oficina_vrs_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                alert('✅ Backup completo exportado com sucesso!');
            } catch (error) {
                alert('❌ Erro ao exportar dados: ' + error.message);
            }
        }

        // Importar dados
        function importarDados() {
            document.getElementById('fileInput').click();
        }

        // Processar arquivo importado
        function processarArquivo(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    
                    if (!confirm('⚠️ ATENÇÃO: Esta ação irá substituir todos os dados atuais. Deseja continuar?')) {
                        return;
                    }
                    
                    if (dados.clientes) {
                        localStorage.setItem('clientes', JSON.stringify(dados.clientes));
                        clientesData = dados.clientes;
                    }
                    if (dados.backups) {
                        localStorage.setItem('backups', JSON.stringify(dados.backups));
                    }
                    if (dados.historico) {
                        localStorage.setItem('historico_cadastros', JSON.stringify(dados.historico));
                    }
                    
                    alert('✅ Dados importados com sucesso!');
                    atualizarEstatisticas();
                    exibirClientes();
                    
                } catch (error) {
                    alert('❌ Erro ao importar dados: Arquivo inválido.');
                }
            };
            reader.readAsText(file);
        }

        // Abrir sistema de backup
        function abrirSistemaBackup() {
            window.open('sistema-backup.html', '_blank');
        }

        // Limpar todos os dados
        function limparTodos() {
            if (!confirm('⚠️ ATENÇÃO: Esta ação irá apagar TODOS os dados permanentemente. Deseja continuar?')) {
                return;
            }
            
            if (!confirm('🚨 ÚLTIMA CONFIRMAÇÃO: Tem certeza absoluta? Esta ação NÃO pode ser desfeita!')) {
                return;
            }
            
            try {
                ['clientes', 'backups', 'historico_cadastros', 'ultimo_backup'].forEach(chave => {
                    localStorage.removeItem(chave);
                });
                
                clientesData = [];
                alert('🗑️ Todos os dados foram removidos.');
                atualizarEstatisticas();
                exibirClientes();
            } catch (error) {
                alert('❌ Erro ao limpar dados: ' + error.message);
            }
        }

        // Recuperar último cliente
        function recuperarUltimo() {
            try {
                const ultimoCliente = localStorage.getItem('ultimo_cliente');
                if (ultimoCliente) {
                    const cliente = JSON.parse(ultimoCliente);
                    alert(`🔄 Último cliente cadastrado:\n\n` +
                          `Nome: ${cliente.nomeCompleto}\n` +
                          `Telefone: ${cliente.telefone}\n` +
                          `E-mail: ${cliente.email}\n` +
                          `Veículo: ${cliente.marca} ${cliente.modelo}\n` +
                          `Data: ${new Date(cliente.dataCadastro).toLocaleString('pt-BR')}`);
                } else {
                    alert('❌ Nenhum cliente encontrado para recuperar.');
                }
            } catch (error) {
                alert('❌ Erro ao recuperar cliente: ' + error.message);
            }
        }

        // Contatar cliente via WhatsApp
        function contatarCliente(index) {
            const cliente = clientesData[index];
            const mensagem = `Olá ${cliente.nomeCompleto}! Aqui é da Oficina VRS. Como posso ajudá-lo?`;
            const telefone = cliente.telefone.replace(/\D/g, '');
            const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
            window.open(url, '_blank');
        }

        // Criar backup específico do cliente
        function criarBackupCliente(index) {
            const cliente = clientesData[index];
            try {
                localStorage.setItem(`backup_cliente_${cliente.id}`, JSON.stringify(cliente));
                alert(`✅ Backup criado para ${cliente.nomeCompleto}`);
            } catch (error) {
                alert('❌ Erro ao criar backup: ' + error.message);
            }
        }

        // Editar cliente (funcionalidade futura)
        function editarCliente(index) {
            const cliente = clientesData[index];
            alert(`📝 Funcionalidade de edição será implementada em breve.\n\nCliente: ${cliente.nomeCompleto}`);
        }

        // Excluir cliente
        function excluirCliente(index) {
            const cliente = clientesData[index];
            
            if (!confirm(`⚠️ Tem certeza que deseja excluir ${cliente.nomeCompleto}?`)) {
                return;
            }
            
            try {
                // Criar backup antes de excluir
                localStorage.setItem(`backup_excluido_${Date.now()}`, JSON.stringify(cliente));
                
                // Remover da lista
                clientesData.splice(index, 1);
                localStorage.setItem('clientes', JSON.stringify(clientesData));
                
                alert(`🗑️ Cliente ${cliente.nomeCompleto} excluído.\n(Backup de segurança criado)`);
                
                atualizarEstatisticas();
                exibirClientes();
            } catch (error) {
                alert('❌ Erro ao excluir cliente: ' + error.message);
            }
        }

        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            // Ctrl + E = Exportar
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportarTodos();
            }
            
            // Ctrl + B = Backup manual
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                criarBackupManual();
            }
            
            // Ctrl + F = Focar na busca
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
        });
    </script>
</body>
</html>
